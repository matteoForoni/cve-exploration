import numpy as np
import os
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sb
import re

def rename_products(list_of_products):
    products_label = []
    for products in list_of_products:
        #print(products)
        products = re.sub('_linux$', '', products)
        products = products.replace('_', '\n')
        products = products.title()
        products_label.append(products)
    return products_label

project_folder = os.getcwd()

## Reading datasets
cve_df = pd.read_csv(f'{project_folder}\\data\\cve.csv')
products_df = pd.read_csv(f'{project_folder}\\data\\products.csv')
vendors_df = pd.read_csv(f'{project_folder}\\data\\vendors.csv')
vendors_products_df = pd.read_csv(f'{project_folder}\\data\\vendor_product.csv')


# data cleaning

# CVE dataset
# print(cve_df.info())

for col in ['access_authentication', 'access_complexity', 'access_vector', 'impact_availability', 'impact_confidentiality', 'impact_integrity']:
    cve_df[col].fillna('NONE', inplace=True)

# print(cve_df.info())

cve_df.rename(columns={'Unnamed: 0': 'cve_id'}, inplace=True)

#print(cve_df.info())

# Product dataset
# print(products_df.info())

# print(sum(products_df['vulnerable_product'].isnull()))

products_df.dropna(inplace=True)

#print(products_df.info())

# Vendor dataset
# print(vendors_df.info())
vendors_df.rename(columns={'Unnamed: 0': 'cve_id'}, inplace=True)
# print(vendors_df.info())

# print(sum(vendors_df['vendor'].isnull()))

vendors_df.dropna(inplace=True)

#print(vendors_df.info())

# Vendor products
# print(vendors_products_df.info())
vendors_products_df.rename(columns={'Unnamed: 0': 'id'}, inplace=True)
#print(vendors_products_df.info())

### Plots

## Heatmaps
plt.figure(figsize=(10,10))
sb.heatmap(cve_df.corr())
plt.savefig('.\\graphs\\correlation-heatmaps.png')

# Products x Vendors
count_products_series = vendors_products_df.groupby('vendor').count()['product']
count_products_series = count_products_series.sort_values(ascending=False)
# print(count_products_series.info())
# print(count_products_series.head())

plt.figure(figsize=(10,10))
plt.xlabel('Vendor')
plt.ylabel('Number of products')
plt.xticks(rotation=45)
plt.bar(count_products_series.index[:10], count_products_series[:10])
plt.title('Products x Vendor')
plt.savefig('.\\graphs\\vendor-x-products.png')

# Vulnerabilities x product
count_vuln_series = products_df.groupby('vulnerable_product').count()['cve_id']
count_vuln_series = count_vuln_series.sort_values(ascending=False)
print(count_vuln_series[:10])
print(count_vuln_series.index[:10].to_list())
print(rename_products(count_vuln_series.index[:20].to_list()))

fig = plt.figure(figsize=(22,10))
plt.xlabel('Product')
plt.ylabel('Number of Vulnerabilities')
plt.bar(count_vuln_series.index[:20], count_vuln_series[:20])
plt.title('Vulnerabilities x Products')
plt.xticks(count_vuln_series.index[:20], labels=rename_products(count_vuln_series.index[:20]))
for i in range(len(count_vuln_series.index[:20])):
    plt.text(i, count_vuln_series[i]//2, count_vuln_series[i], ha = 'center', 
        bbox = dict(facecolor = 'white', alpha = .5))
plt.savefig('.\\graphs\\vuln-x-products.png')
