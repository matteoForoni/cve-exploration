import numpy as np
import os
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sb

project_folder = os.getcwd()

## Reading datasets
cve_df = pd.read_csv(f'{project_folder}\\data\\cve.csv')
products_df = pd.read_csv(f'{project_folder}\\data\\products.csv')
vendors_df = pd.read_csv(f'{project_folder}\\data\\vendors.csv')
vendors_products_df = pd.read_csv(f'{project_folder}\\data\\vendor_product.csv')


# data cleaning

# CVE dataset
# print(cve_df.info())

for col in ['access_authentication', 'access_complexity', 'access_vector', 'impact_availability', 'impact_confidentiality', 'impact_integrity']:
    cve_df[col].fillna('NONE', inplace=True)

# print(cve_df.info())

cve_df.rename(columns={'Unnamed: 0': 'cve_id'}, inplace=True)

#print(cve_df.info())

# Product dataset
# print(products_df.info())

# print(sum(products_df['vulnerable_product'].isnull()))

products_df.dropna(inplace=True)

#print(products_df.info())

# Vendor dataset
# print(vendors_df.info())
vendors_df.rename(columns={'Unnamed: 0': 'cve_id'}, inplace=True)
# print(vendors_df.info())

# print(sum(vendors_df['vendor'].isnull()))

vendors_df.dropna(inplace=True)

#print(vendors_df.info())

# Vendor products
# print(vendors_products_df.info())
vendors_products_df.rename(columns={'Unnamed: 0': 'id'}, inplace=True)
#print(vendors_products_df.info())

### Plots

## Heatmaps
plt.figure(figsize=(10,10))
sb.heatmap(cve_df.corr())
plt.savefig('.\\graphs\\correlation-heatmaps.png')

count_products_series = vendors_products_df.groupby('vendor').count()['product']
count_products_series = count_products_series.sort_values(ascending=False)
print(count_products_series.info())
print(count_products_series.head())

plt.figure(figsize=(10,10))
plt.xlabel('Vendor')
plt.ylabel('Number of products')
plt.xticks(rotation=45)
plt.bar(count_products_series.index[:10], count_products_series[:10])
plt.title('Products x Vendor')
plt.savefig('.\\graphs\\vendor-x-products.png')
